@model List<DemoDB2.ViewModels.GioHangViewModel>
@{
    ViewBag.Title = "Giỏ Hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <h2>Giỏ Hàng</h2>
    @if (Model.Any())
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Tên Món</th>
                    <th>Hình Ảnh</th>
                    <th>Giá</th>
                    <th>Số Lượng</th>
                    <th>Tổng</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr class="cart-item" data-id="@item.MonAnId">
                        <td>@item.TenMon</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.ImageMonAn))
                            {
                                <img src="@Url.Content(item.ImageMonAn)"
                                     alt="@item.TenMon"
                                     class="product-image"
                                     onerror="this.src='@Url.Content("~/Content/images/no-image.jpg")'" />
                            }
                            else
                            {
                                <img src="@Url.Content("~/Content/images/no-image.jpg")"
                                     alt="No Image Available"
                                     class="product-image" />
                            }
                        </td>
                        <td class="item-price">@string.Format("{0:N0} VND", item.GiaMon)</td>
                        <td>
                            <div class="quantity-control">
                                <button class="btn btn-sm btn-secondary decrease-quantity">-</button>
                                <input type="number"
                                       class="form-control quantity-input"
                                       value="@item.SoLuong"
                                       min="1"
                                       style="width: 60px;" />
                                <button class="btn btn-sm btn-secondary increase-quantity">+</button>
                            </div>
                        </td>
                        <td class="item-total">@string.Format("{0:N0} VND", item.GiaMon * item.SoLuong)</td>
                        <td>
                            <button class="btn btn-danger btn-sm remove-item">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-right"><strong>Tổng cộng:</strong></td>
                    <td colspan="2" class="cart-total">
                        <strong>@string.Format("{0:N0} VND", Model.Sum(m => m.GiaMon * m.SoLuong))</strong>
                    </td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-3">
            <a href="@Url.Action("ThanhToan", "DichVu")" class="btn btn-primary">
                <i class="fas fa-credit-card"></i> Thanh Toán
            </a>
            <a href="@Url.Action("ViewMonAnKH", "DichVu")" class="btn btn-secondary">
                <i class="fas fa-shopping-cart"></i> Tiếp tục mua hàng
            </a>
        </div>
    }
    else
    {
        <div class="text-center">
            <p class="lead">Giỏ hàng của bạn đang trống</p>
            <a href="@Url.Action("ViewMonAnKH","DichVu")" class="btn btn-primary">
                <i class="fas fa-shopping-cart"></i> Tiếp tục mua hàng
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Hàm định dạng số tiền
            function formatMoney(amount) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(amount);
            }

            // Hàm cập nhật số lượng
            function updateQuantity(monAnId, soLuong) {
                $.ajax({
                    url: '@Url.Action("CapNhatSoLuong", "DichVu")',
                    type: 'POST',
                    data: { monAnId: monAnId, soLuong: soLuong },
                    success: function (result) {
                        if (result.success) {
                            // Cập nhật tổng tiền của món
                            var row = $('.cart-item[data-id="' + monAnId + '"]');
                            row.find('.item-total').text(formatMoney(result.itemTotal));

                            // Cập nhật tổng tiền giỏ hàng
                            $('.cart-total strong').text(formatMoney(result.total));

                            // Nếu số lượng = 0, xóa dòng
                            if (soLuong <= 0) {
                                row.remove();
                                if ($('.cart-item').length === 0) {
                                    location.reload(); // Tải lại trang nếu giỏ hàng trống
                                }
                            }
                        }
                    }
                });
            }

            // Xử lý nút giảm số lượng
            $('.decrease-quantity').click(function () {
                var row = $(this).closest('.cart-item');
                var input = row.find('.quantity-input');
                var currentValue = parseInt(input.val());
                if (currentValue > 1) {
                    input.val(currentValue - 1);
                    updateQuantity(row.data('id'), currentValue - 1);
                }
            });

            // Xử lý nút tăng số lượng
            $('.increase-quantity').click(function () {
                var row = $(this).closest('.cart-item');
                var input = row.find('.quantity-input');
                var currentValue = parseInt(input.val());
                input.val(currentValue + 1);
                updateQuantity(row.data('id'), currentValue + 1);
            });

            // Xử lý khi nhập số lượng trực tiếp
            $('.quantity-input').change(function () {
                var row = $(this).closest('.cart-item');
                var soLuong = parseInt($(this).val());
                if (soLuong < 1) {
                    $(this).val(1);
                    soLuong = 1;
                }
                updateQuantity(row.data('id'), soLuong);
            });

            // Xử lý nút xóa
            $('.remove-item').click(function () {
                var row = $(this).closest('.cart-item');
                var monAnId = row.data('id');

                if (confirm('Bạn có chắc muốn xóa món ăn này khỏi giỏ hàng?')) {
                    $.ajax({
                        url: '@Url.Action("XoaMonKhoiGio", "DichVu")',
                        type: 'POST',
                        data: { monAnId: monAnId },
                        success: function (result) {
                            if (result.success) {
                                row.remove();
                                $('.cart-total strong').text(formatMoney(result.total));

                                if ($('.cart-item').length === 0) {
                                    location.reload();
                                }
                            }
                        }
                    });
                }
            });
        });
    </script>
}

<style>
    .quantity-control {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .quantity-input {
        text-align: center;
    }

    .product-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
        transition: transform 0.2s ease-in-out;
    }

        .product-image:hover {
            transform: scale(1.1);
        }
</style>